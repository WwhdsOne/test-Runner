name: TestPipeline

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - run: echo "ğŸ‰ The job was automatically triggered by a ${{ gitea.event_name }} event."
      - run: echo "ğŸ§ This job is now running on a ${{ runner.os }} server hosted by Gitea!"
      - run: echo "ğŸ” The name of your branch is ${{ gitea.ref }} and your repository is ${{ gitea.repository }}."

      - name: Checkout code
        run: |
          # å®‰è£… git
          sudo apt-get update
          sudo apt-get install -y git
          # å…‹éš†ä»£ç 
          git clone http://47.93.83.136:3000/Wwhds_one/test-Pipeline.git .
          # å¦‚æœä½ éœ€è¦ä½¿ç”¨ token è®¤è¯ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤
          # git clone http://wwh852456@47.93.83.136:3000/Wwhds_one/test-Pipeline.git .
          # æ³¨æ„ï¼šä¸å»ºè®®å°† token æ˜æ–‡å†™åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œå»ºè®®ä½¿ç”¨ secrets æ¥ç®¡ç†
      - run: echo "ğŸ’¡ The ${{ gitea.repository }} repository has been cloned to the runner."

      - name: Set up Go
        run: |
          # ä¸‹è½½å¹¶å®‰è£… Go
          wget https://go.dev/dl/go1.21.6.linux-amd64.tar.gz  # è¿™é‡Œä½¿ç”¨ Go 1.21.6 ç‰ˆæœ¬ï¼Œä½ å¯ä»¥æ ¹æ®éœ€è¦ä¿®æ”¹
          sudo rm -rf /usr/local/go
          sudo tar -C /usr/local -xzf go1.21.6.linux-amd64.tar.gz
          # é…ç½®ç¯å¢ƒå˜é‡
          echo 'export PATH=$PATH:/usr/local/go/bin' >> ~/.bashrc
          source ~/.bashrc
          # éªŒè¯ Go å®‰è£…
          go version

      - name: Cache Go modules
        run: |
          # è¿™é‡Œç®€å•è¯´æ˜ï¼Œä¸ä½¿ç”¨ actions/cache çš„è¯ï¼Œç¼“å­˜é€»è¾‘éœ€è¦è‡ªå·±å®ç°
          # å¯ä»¥å°†ç¼“å­˜æ–‡ä»¶ä¿å­˜åˆ°æŒ‡å®šç›®å½•ï¼Œæ¯æ¬¡æ„å»ºå‰æ£€æŸ¥æ˜¯å¦å­˜åœ¨ç¼“å­˜å¹¶æ¢å¤
          # ä¾‹å¦‚ï¼š
          CACHE_DIR=~/go-module-cache
          if [ -d "$CACHE_DIR" ]; then
            cp -r $CACHE_DIR ~/go/pkg/mod
          fi

      - name: Update Go dependencies
        run: |
          go get -u || { echo "Failed to update Go dependencies"; exit 1; }

      - name: Tidy Go modules
        run: |
          go mod tidy || { echo "Failed to tidy Go modules"; exit 1; }

      - name: Check Docker status
        run: docker info

      - name: Build Docker image
        run: docker build -t go-testPipeline .
        # æ„å»º Docker é•œåƒï¼Œä½¿ç”¨å½“å‰ç›®å½•ä¸‹çš„ Dockerfile

      - name: Start Docker container
        run: docker run -d --name go-testPipeline-container --network host go-testPipeline
        # å¯åŠ¨ Docker å®¹å™¨