name: TestPipeline

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: self-hosted
    container:
      image: golang:1.24-alpine
    steps:
      - run: echo "ğŸ‰ The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "ğŸ§ This job is now running on a ${{ runner.os }} server hosted by GitHub!"
      - run: echo "ğŸ” The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."
      - name: Check out repository code
        uses: actions/checkout@v4
      - run: echo "ğŸ’¡ The ${{ github.repository }} repository has been cloned to the runner."
      - run: echo "ğŸ–¥ï¸ The workflow is now ready to test your code on the runner."

      - name: Update Go dependencies
        run: |
          cd test-Pipeline
          export GOPROXY=https://goproxy.cn,direct
          go get -u

      - name: Build Go application
        run: |
          cd test-Pipeline 
          go build -o mygo

      - name: Check for existing Docker container
        run: |
          # æ£€æŸ¥åä¸ºmygoçš„å®¹å™¨æ˜¯å¦æ­£åœ¨è¿è¡Œ
          if docker ps --filter name=mygo --format "{{.Names}}" | grep -q mygo; then
            # å¦‚æœå®¹å™¨æ­£åœ¨è¿è¡Œï¼Œåˆ™åœæ­¢å¹¶ç§»é™¤å®ƒ
            docker stop mygo
            docker rm mygo
          fi

      - name: Check for existing Docker image
        run: |
          # æ£€æŸ¥åä¸ºmygoçš„é•œåƒæ˜¯å¦å­˜åœ¨
          if docker images --format "{{.Repository}}:{{.Tag}}" | grep -q "mygo:latest"; then
            # å¦‚æœé•œåƒå­˜åœ¨ï¼Œåˆ™ç§»é™¤å®ƒ
            docker rmi mygo:latest
          fi

      - name: Build Docker image
        run: |
          # ä½¿ç”¨ Dockerfile æ„å»ºé•œåƒï¼Œå¹¶æŒ‡å®šé•œåƒåç§°ä¸ºmygo
          docker build -t mygo:latest .

      - name: Run Docker container
        run: |
          # å¯åŠ¨æ–°é•œåƒçš„å®¹å™¨ï¼ŒæŒ‡å®šå®¹å™¨åç§°ä¸ºmygoï¼Œä½¿ç”¨ --network host æ¨¡å¼å¹¶åå°è¿è¡Œ
          docker run -d --network host --name mygo mygo:latest
